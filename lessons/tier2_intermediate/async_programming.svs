//==================================================
// File: async_programming.svs
//==================================================
// Author: ZobieLabs
// License: Duality Public License (DPL v1.0)
// Goal: Understand async/await, cooperative scheduling, and timeouts
// Objective: Demonstrate asynchronous task execution with await patterns
//==================================================

//==================================================
// Section 1.0 - Lesson Objective
//==================================================

// Interactive guided tutorial: Master asynchronous programming
// Run with: ./scripts/build.sh lessons/tier2_intermediate/async_programming.svs

//==================================================
// Section 2.0 - Tutorial Execution
//==================================================

import <string> as strings;

const TASK_DELAY_MS = 150;

fn async_fetch(label, delay_ms) {
    println("[", label, "] scheduling work");
    sleep(delay_ms);
    println("[", label, "] finished after ", delay_ms, " ms");
    return strings.concat(label, "-value");
}

async fn fetch_report() {
    let first = async async_fetch("alpha", TASK_DELAY_MS);
    let second = async async_fetch("beta", TASK_DELAY_MS + 50);

    let first_value = await first;
    let second_value = await second;

    return [first_value, second_value];
}

fn run_tutorial() {
    println("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    println("â•‘  Tier 2: Async Programming                                â•‘");
    println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    println();

    println("ğŸ“š What you'll learn:");
    println("  â€¢ How to use async/await for concurrent tasks");
    println("  â€¢ How cooperative scheduling works in SolvraCore");
    println("  â€¢ How to spawn and await async functions");
    println("  â€¢ Why async matters for efficient resource use");
    println();

    println("Let's begin!");
    println();

    // Concept 1: What is Async Programming?
    println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
    println("ğŸ“– Concept 1: Understanding Async Programming");
    println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
    println();
    println("Async programming lets multiple tasks run concurrently");
    println("without blocking each other. This is crucial for:");
    println("  â€¢ Network operations (API calls, downloads)");
    println("  â€¢ I/O operations (file reading, database queries)");
    println("  â€¢ Long-running computations");
    println();
    println("In SolvraCore, async tasks cooperate using a scheduler.");
    println("While one task waits (sleep, I/O), others can run!");
    println();

    let continue1 = inp("Press Enter to continue...");
    println();

    // Concept 2: async and await Keywords
    println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
    println("ğŸ“– Concept 2: The async and await Keywords");
    println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
    println();
    println("Syntax:");
    println("  async fn my_function() {");
    println("      let task = async some_work();");
    println("      let result = await task;");
    println("      return result;");
    println("  }");
    println();
    println("Key points:");
    println("  â€¢ 'async fn' declares an asynchronous function");
    println("  â€¢ 'async expression' spawns a concurrent task");
    println("  â€¢ 'await task' pauses until the task completes");
    println();
    println("Let's see it in action with timing!");
    println();

    let continue2 = inp("Press Enter to continue...");
    println();

    // Concept 3: Running Async Tasks
    println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
    println("ğŸ“– Concept 3: Running Concurrent Tasks");
    println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
    println();
    println("Watch as we spawn two async tasks:");
    println("  Task alpha: ", TASK_DELAY_MS, "ms delay");
    println("  Task beta:  ", TASK_DELAY_MS + 50, "ms delay");
    println();
    println("Both tasks will run concurrently!");
    println();

    let start = time();
    let job = async fetch_report();
    let values = await job;
    let mut elapsed = time() - start;
    if elapsed < 0 {
        elapsed = 0;
    }

    println();
    println("Collected values: ", values[0], ", ", values[1]);
    println("Total elapsed time: ", elapsed, " seconds");
    println();
    println("Notice: Both tasks ran at the same time!");
    println("Sequential execution would take longer.");
    println();

    let continue3 = inp("Press Enter to continue...");
    println();

    // Concept 4: Why Async Matters for SolvraCore
    println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
    println("ğŸ“– Concept 4: Why Async Matters for SolvraCore");
    println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
    println();
    println("SolvraCore's async scheduler enables:");
    println("  â€¢ Efficient resource usage (CPU, memory, I/O)");
    println("  â€¢ Responsive applications (no blocking)");
    println("  â€¢ Scalable systems (handle many tasks)");
    println("  â€¢ AI micro-agents (concurrent decision-making)");
    println();
    println("This is essential for:");
    println("  â€¢ Real-time embedded systems");
    println("  â€¢ Network services and APIs");
    println("  â€¢ Multi-sensor data processing");
    println("  â€¢ Autonomous agent coordination");
    println();

    // Quick self-check
    if len(values) == 2 {
        println("[Self Check] Both async tasks completed successfully!");
    } else {
        println("[Self Check] Missing async result - investigate!");
    }
    println();

    let continue4 = inp("Press Enter to continue...");
    println();

    // Try-It-Yourself Section
    println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    println("âœï¸  Try-It-Yourself Challenge");
    println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    println();
    println("Let's test your understanding!");
    println();

    println("Question: What does 'await' do in async programming?");
    println("  a) Immediately returns a value");
    println("  b) Pauses until a task completes");
    println("  c) Cancels a running task");
    println();

    let answer = inp("Your answer (a/b/c): ");
    println();

    if answer == "b" || answer == "B" {
        println("âœ“ Correct! 'await' pauses execution until the task finishes.");
        println("  This lets other tasks run while waiting.");
        println("  Example: let result = await my_task;");
    } else {
        println("âœ— Not quite. The correct answer is 'b' â€” pauses until complete");
        println("  'await' suspends the current function until the async");
        println("  task completes, allowing other tasks to run in the meantime.");
        println("  This is cooperative multitasking!");
    }
    println();

    let continue5 = inp("Press Enter to see summary...");
    println();

    // Summary
    println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    println("ğŸ“‹ Lesson Summary");
    println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    println();
    println("Today you learned:");
    println("  âœ“ How async/await enables concurrent task execution");
    println("  âœ“ How to spawn tasks with 'async' and wait with 'await'");
    println("  âœ“ Why cooperative scheduling is efficient");
    println("  âœ“ How async powers SolvraCore's scalability");
    println();
    println("Key Takeaway:");
    println("  SolvraCore's async scheduler enables cooperative multitasking");
    println("  for efficient resource use. This is crucial for embedded systems,");
    println("  AI agents, and real-time applications.");
    println();

    // Next Steps
    println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
    println("What would you like to do?");
    println("  [1] View lesson again");
    println("  [2] Continue to next lesson");
    println("  [3] Exit");
    println();

    let choice = inp("Your choice (1/2/3): ");
    println();

    if choice == "1" {
        println("ğŸ“– Restarting lesson...");
        println();
        run_tutorial();
    } else if choice == "2" {
        println("ğŸ“ Great! Continue to the next Tier 2 lesson:");
        println("   ./scripts/learn.sh");
    } else {
        println("ğŸ‘‹ Thanks for learning with us! See you next time.");
    }
    println();
}

fn main() {
    run_tutorial();
}

//--------------------------------------------------
// End comments: Shows async/await for concurrent task execution with timing
// @ZNOTE: SolvraCore scheduler enables cooperative multitasking for efficient resource use
//--------------------------------------------------

//==================================================
// End of file
//==================================================
